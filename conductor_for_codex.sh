#!/usr/bin/env bash
#
# conductor_for_codex.sh
#
# Offline installer for Codex + Conductor skills (no network).
# Non-destructive by default:
# - Does NOT delete user project files.
# - Overwrites existing files/folders to ensure updates are applied.
#
# Installs into your HOME by default (no sudo):
#   $HOME/.codex/skills/<skill>/SKILL.md
# Installs a global init command (if missing):
#   $HOME/.local/bin/codex_conductor_init
#
# Transparency note:
# - Skill markdown content is copied from plain files in ./skills.
# - No base64 payloads are used for skill installation.
#
# Override paths via env vars:
#   CODEX_HOME=/custom/.codex BIN_DIR=/custom/bin bash ./conductor_for_codex.sh
#
set -euo pipefail

CODEX_HOME="${CODEX_HOME:-$HOME/.codex}"
BIN_DIR="${BIN_DIR:-$HOME/.local/bin}"
NO_PATH_HINT="${NO_PATH_HINT:-0}"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BUNDLED_SKILLS_ROOT="$SCRIPT_DIR/skills"
BUNDLED_TEMPLATES_ROOT="$SCRIPT_DIR/templates"

echo "==========================================="
echo "  Conductor for Codex - Installer (Linux)"
echo "==========================================="
echo ""

if [[ ! -d "$BUNDLED_SKILLS_ROOT" ]]; then
  echo "Missing bundled skills directory: $BUNDLED_SKILLS_ROOT"
  exit 1
fi

mkdir -p "$CODEX_HOME/skills" "$BIN_DIR"

# Install skills one-by-one (overwrite if destination exists)
for s in conductor-setup conductor-status conductor-implement conductor-newTrack conductor-revert conductor-review conductor-check-upstream update-conductor; do
  src_file="$BUNDLED_SKILLS_ROOT/$s/SKILL.md"
  dst_dir="$CODEX_HOME/skills/$s"
  dst_file="$dst_dir/SKILL.md"

  if [[ ! -f "$src_file" ]]; then
    echo "Missing bundled skill file: $src_file"
    exit 1
  fi

  mkdir -p "$dst_dir"
  cp -a "$src_file" "$dst_file"
  echo "  Installed: $dst_dir"
done

# Install templates (overwrite if destination exists)
if [[ -d "$BUNDLED_TEMPLATES_ROOT" ]]; then
  mkdir -p "$CODEX_HOME/conductor/templates"
  cp -a "$BUNDLED_TEMPLATES_ROOT"/. "$CODEX_HOME/conductor/templates/"
  echo "  Installed templates: $CODEX_HOME/conductor/templates"
else
  echo "  Missing bundled templates directory (skipping): $BUNDLED_TEMPLATES_ROOT"
fi

# Install init command only if missing
if [[ -e "$BIN_DIR/codex_conductor_init" ]]; then
  echo "  Exists, skipping: $BIN_DIR/codex_conductor_init"
else
  cat >"$BIN_DIR/codex_conductor_init" <<'INIT_EOF'
#!/usr/bin/env bash
# codex_conductor_init
#
# Non-destructive by default:
# - Does NOT delete user project files.
# - Overwrites existing files/folders to ensure updates.
#
# Usage:
#   codex_conductor_init            # initializes current directory
#   codex_conductor_init /path/to/repo
#
set -euo pipefail

REPO_ROOT="${1:-$(pwd)}"
CODEX_HOME="${CODEX_HOME:-$HOME/.codex}"

skill_names=(conductor-setup conductor-status conductor-implement conductor-newTrack conductor-revert conductor-review conductor-check-upstream update-conductor)

mkdir -p "$REPO_ROOT/.codex/skills"

for s in "${skill_names[@]}"; do
  src="$CODEX_HOME/skills/$s"
  dst="$REPO_ROOT/.codex/skills/$s"
  [[ -d "$src" ]] || { echo "Missing installed skill: $src"; exit 1; }
  cp -a "$src" "$dst"
  echo "  Installed: .codex/skills/$s"
done

# Install Conductor templates (overwrites existing files)
if [[ -d "$CODEX_HOME/conductor/templates" ]]; then
  mkdir -p "$REPO_ROOT/conductor/templates"
  cp -a "$CODEX_HOME/conductor/templates"/. "$REPO_ROOT/conductor/templates/"
  echo "  Installed: conductor/templates"
else
  echo "  NOTE: Missing templates at $CODEX_HOME/conductor/templates (re-run conductor_for_codex.sh)"
fi

rule_line='Always run $conductor-status before doing anything else.'
if [[ -e "$REPO_ROOT/AGENTS.md" ]]; then
  if command -v grep >/dev/null 2>&1; then
    if ! grep -Fxq "$rule_line" "$REPO_ROOT/AGENTS.md"; then
      echo "$rule_line" >>"$REPO_ROOT/AGENTS.md"
    fi
  else
    echo "$rule_line" >>"$REPO_ROOT/AGENTS.md" || true
  fi
  echo "  Ensured AGENTS.md contains conductor-status rule"
else
  cat >"$REPO_ROOT/AGENTS.md" <<'AGENTS_EOF'
# AGENTS.md

Always run $conductor-status before doing anything else.


AGENTS_EOF
  echo "  Created AGENTS.md"
fi

INIT_EOF
  chmod +x "$BIN_DIR/codex_conductor_init"
  echo "  Created: $BIN_DIR/codex_conductor_init"
fi

if [[ "$NO_PATH_HINT" != "1" ]]; then
  case ":${PATH}:" in
    *":${BIN_DIR}:"*) ;;
    *) echo "  NOTE: Add $BIN_DIR to PATH to run codex_conductor_init from anywhere." ;;
  esac
fi

echo ""
echo "Run in any repo directory:"
echo "  codex_conductor_init"
